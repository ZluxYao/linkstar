package main

import (
	"fmt"
	"log"
	"net"
	"net/http"
	"sync"
	"time"

	"github.com/huin/goupnp/dcps/internetgateway1"
	"github.com/pion/stun"
)

// ============ é…ç½® ============
const (
	LocalServicePort = 3333 // æœ¬åœ° HTTP æœåŠ¡ç«¯å£
)

var (
	// TCP STUN æœåŠ¡å™¨åˆ—è¡¨
	stunServers = []string{
		"52.24.174.49:3478",
		"35.158.233.7:3478",
		"69.20.59.115:3478",
		"54.197.117.0:3478",
		"35.177.202.92:3478",
		"203.56.112.226:3478",
		"80.155.54.123:3478",
		"52.57.137.123:3478",
		"172.233.245.118:3478",
		"176.9.24.184:3478",
		"3.78.237.53:3478",
		"194.149.74.158:3478",
		"23.21.92.55:3478",
		"52.52.70.85:3478",
		"108.163.134.186:3478",
		"66.228.54.23:3478",
		"34.74.124.204:3478",
		"217.146.224.74:3478",
		"24.204.48.11:3478",
		"193.22.17.97:3478",
	}

	publicIP         string
	routerIP         string
	stunMappedPort   int
	localIP          string
	bestSTUN         string
	stunConn         net.Conn
	upnpClients      []*internetgateway1.WANIPConnection1
	isDoubleNAT      bool
	natType          string
	routerMappedPort int
)

func main() {
	fmt.Println("=== TCP STUN + UPnP åŒå±‚ NAT ç©¿é€ï¼ˆç¨³å®šç‰ˆï¼‰===\n")
	var err error
	localIP, err = getLocalIPAddr()
	if err != nil {
		log.Fatalf("âŒ è·å–æœ¬æœºIPå¤±è´¥: %v\n", err)
	}

	// æ­¥éª¤ 1: å¯åŠ¨æœ¬åœ°æœåŠ¡
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	fmt.Println("ğŸ“¡ æ­¥éª¤ 1: å¯åŠ¨æœ¬åœ° HTTP æœåŠ¡")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	startLocalHTTPService(LocalServicePort)

	// æ­¥éª¤ 2: é€‰æ‹©æœ€å¿« STUN æœåŠ¡å™¨
	fmt.Println("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	fmt.Println("ğŸ” æ­¥éª¤ 2: æµ‹è¯• TCP STUN æœåŠ¡å™¨")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	selectBestSTUN()

	// æ­¥éª¤ 3: TCP STUN è·å–è¿è¥å•† NAT æ˜ å°„
	fmt.Println("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	fmt.Println("ğŸŒ æ­¥éª¤ 3: è·å–è¿è¥å•† NAT æ˜ å°„ç«¯å£")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	if !getISPNATMapping() {
		log.Fatal("âŒ è·å–è¿è¥å•† NAT æ˜ å°„å¤±è´¥")
	}

	// æ­¥éª¤ 4: æ£€æµ‹ NAT ç±»å‹
	fmt.Println("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	fmt.Println("ğŸ” æ­¥éª¤ 4: æ£€æµ‹ NAT ç±»å‹")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	detectNATType()

	// æ­¥éª¤ 5: UPnP æ˜ å°„æœ¬åœ°ç«¯å£åˆ°è¿è¥å•†ç«¯å£ï¼ˆç¨³å®šç‰ˆï¼‰
	fmt.Println("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	fmt.Println("ğŸ”§ æ­¥éª¤ 5: UPnP ç«¯å£æ˜ å°„ï¼ˆç¨³å®šç‰ˆç­–ç•¥ï¼‰")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	setupStableUPnPMapping()

	// æ­¥éª¤ 6: ä¿æŒæ˜ å°„æ´»è·ƒ
	go keepMappingAlive()

	// æ˜¾ç¤ºæœ€ç»ˆä¿¡æ¯
	displayFinalInfo()

	select {}
}

// ========== æ­¥éª¤ 1: å¯åŠ¨æœ¬åœ°æœåŠ¡ ==========
func startLocalHTTPService(port int) {
	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		w.Header().Set("Content-Type", "text/html; charset=utf-8")

		natStatus := "å•å±‚ NAT"
		accessURL := fmt.Sprintf("http://%s:%d", publicIP, routerMappedPort)

		if isDoubleNAT {
			natStatus = "åŒå±‚ NAT (å·²é€šè¿‡ç«¯å£åŒæ­¥ç©¿é€)"
			if routerMappedPort == stunMappedPort {
				accessURL = fmt.Sprintf("http://%s:%d", publicIP, stunMappedPort)
			}
		}

		html := fmt.Sprintf(`<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>åŒå±‚ NAT ç©¿é€æˆåŠŸï¼</title>
	<style>
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			max-width: 900px;
			margin: 50px auto;
			padding: 30px;
			background: linear-gradient(135deg, #667eea 0%%, #764ba2 100%%);
			color: white;
		}
		.card {
			background: rgba(255,255,255,0.98);
			color: #333;
			padding: 40px;
			border-radius: 16px;
			box-shadow: 0 20px 60px rgba(0,0,0,0.4);
		}
		h1 { color: #667eea; margin-bottom: 30px; }
		.status { 
			background: linear-gradient(135deg, #10b981 0%%, #059669 100%%);
			color: white; 
			padding: 20px; 
			border-radius: 12px; 
			margin: 25px 0;
			box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
		}
		.success {
			background: linear-gradient(135deg, #3b82f6 0%%, #2563eb 100%%);
			color: white;
			padding: 20px;
			border-radius: 12px;
			margin: 25px 0;
		}
		.info { 
			background: #f8fafc; 
			padding: 20px; 
			border-radius: 8px; 
			margin: 15px 0;
			border-left: 4px solid #667eea;
		}
		.badge {
			display: inline-block;
			background: #667eea;
			color: white;
			padding: 4px 12px;
			border-radius: 12px;
			font-size: 12px;
			font-weight: bold;
			margin-left: 10px;
		}
		.port-map {
			background: #1e293b;
			color: #10b981;
			padding: 15px;
			border-radius: 8px;
			font-family: 'Courier New', monospace;
			margin: 15px 0;
		}
	</style>
</head>
<body>
	<div class="card">
		<h1>ğŸ‰ åŒå±‚ NAT ç©¿é€æˆåŠŸï¼</h1>
		<div class="status">
			<strong>âœ… è¿æ¥çŠ¶æ€:</strong> å·²å»ºç«‹ <span class="badge">TCP</span><br>
			<strong>ğŸ“¡ å®¢æˆ·ç«¯ IP:</strong> %s<br>
			<strong>â° è®¿é—®æ—¶é—´:</strong> %s<br>
			<strong>ğŸŒ NAT ç¯å¢ƒ:</strong> %s<br>
			<strong>ğŸ” NAT ç±»å‹:</strong> %s
		</div>
		%s
		<div class="info">
			<h3>ğŸ’¡ ç«¯å£æ˜ å°„è·¯å¾„</h3>
			<div class="port-map">
äº’è”ç½‘è®¿é—®: %s<br>
   â†“<br>
[è¿è¥å•† NAT] %s:%d<br>
   â†“<br>
[å®¶åº­è·¯ç”±å™¨] %s:%d<br>
   â†“<br>
[æœ¬æœºæœåŠ¡] %s:%d
			</div>
		</div>
		<div class="info">
			<h3>ğŸ”§ æŠ€æœ¯åŸç†ï¼ˆç¨³å®šç‰ˆï¼‰</h3>
			<p><strong>TCP STUN æ¢æµ‹:</strong> è·å–è¿è¥å•† NAT åˆ†é…çš„ç«¯å£ %d<br>
			<strong>UPnP æ°¸ä¹…æ˜ å°„:</strong> è·¯ç”±å™¨å¤–éƒ¨ç«¯å£ %d â†’ æœ¬åœ° %d<br>
			<strong>è‡ªåŠ¨å†²çªå¤„ç†:</strong> å¿½ç•¥ 718 é”™è¯¯ï¼Œå°è¯•æ‰€æœ‰å¯ç”¨ç½‘å…³<br>
			<strong>åŒå±‚ç©¿é€:</strong> ä¿æŒ TCP è¿æ¥æ´»è·ƒï¼Œç»´æŒä¸¤å±‚ NAT æ˜ å°„</p>
		</div>
	</div>
</body>
</html>`,
			r.RemoteAddr,
			time.Now().Format("2006-01-02 15:04:05"),
			natStatus,
			natType,
			func() string {
				if isDoubleNAT && routerMappedPort == stunMappedPort {
					return `<div class="success">
						<strong>âœ… åŒå±‚ NAT å·²æˆåŠŸç©¿é€ï¼</strong><br>
						é€šè¿‡ç«¯å£åŒæ­¥æŠ€æœ¯ï¼Œè·¯ç”±å™¨ç«¯å£ä¸è¿è¥å•†ç«¯å£ä¿æŒä¸€è‡´ã€‚<br>
						å¤–ç½‘å¯ä»¥é€šè¿‡ ` + accessURL + ` è®¿é—®æœ¬æœºæœåŠ¡ã€‚
					</div>`
				} else if isDoubleNAT {
					return `<div class="success">
						<strong>âš ï¸ ç«¯å£ä¸å®Œå…¨åŒæ­¥</strong><br>
						è·¯ç”±å™¨ç«¯å£ (` + fmt.Sprintf("%d", routerMappedPort) + `) ä¸è¿è¥å•†ç«¯å£ (` + fmt.Sprintf("%d", stunMappedPort) + `) ä¸ä¸€è‡´ã€‚<br>
						å¯èƒ½éœ€è¦æ‰‹åŠ¨é…ç½®è·¯ç”±å™¨ç«¯å£è½¬å‘ã€‚
					</div>`
				}
				return ""
			}(),
			accessURL,
			publicIP, stunMappedPort,
			routerIP, routerMappedPort,
			localIP, LocalServicePort,
			stunMappedPort,
			routerMappedPort,
			LocalServicePort,
		)

		w.Write([]byte(html))
		log.Printf("âœ… [HTTP] æ”¶åˆ°è¯·æ±‚: %s %s from %s\n", r.Method, r.URL.Path, r.RemoteAddr)
	})

	go func() {
		addr := fmt.Sprintf("0.0.0.0:%d", port)
		fmt.Printf("âœ… HTTP æœåŠ¡å·²å¯åŠ¨: %s\n", addr)
		if err := http.ListenAndServe(addr, nil); err != nil {
			log.Fatalf("âŒ HTTP æœåŠ¡å™¨å¯åŠ¨å¤±è´¥: %v\n", err)
		}
	}()

	time.Sleep(300 * time.Millisecond)
}

// ========== æ­¥éª¤ 2: é€‰æ‹©æœ€å¿« STUN æœåŠ¡å™¨ ==========
func selectBestSTUN() {
	type result struct {
		server string
		delay  time.Duration
	}

	results := make(chan result, len(stunServers))
	var wg sync.WaitGroup

	for _, server := range stunServers {
		wg.Add(1)
		go func(srv string) {
			defer wg.Done()

			start := time.Now()
			conn, err := net.DialTimeout("tcp", srv, 3*time.Second)
			if err != nil {
				return
			}
			defer conn.Close()

			msg := stun.MustBuild(stun.TransactionID, stun.BindingRequest)
			_, err = conn.Write(msg.Raw)
			if err != nil {
				return
			}

			conn.SetReadDeadline(time.Now().Add(3 * time.Second))
			buf := make([]byte, 1024)
			n, err := conn.Read(buf)
			if err != nil || n == 0 {
				return
			}

			delay := time.Since(start)
			fmt.Printf("  âœ“ %s - %dms\n", srv, delay.Milliseconds())
			results <- result{server: srv, delay: delay}
		}(server)
	}

	go func() {
		wg.Wait()
		close(results)
	}()

	var bestDelay time.Duration = time.Hour
	for res := range results {
		if res.delay < bestDelay {
			bestDelay = res.delay
			bestSTUN = res.server
		}
	}

	if bestSTUN == "" {
		log.Fatal("âŒ æ— æ³•è¿æ¥ä»»ä½• TCP STUN æœåŠ¡å™¨")
	}
	fmt.Printf("ğŸ¯ é€‰æ‹©æœ€å¿«çš„: %s (%dms)\n", bestSTUN, bestDelay.Milliseconds())
}

// ========== æ­¥éª¤ 3: è·å–è¿è¥å•† NAT æ˜ å°„ç«¯å£ ==========
func getISPNATMapping() bool {
	conn, err := net.DialTimeout("tcp", bestSTUN, 5*time.Second)
	if err != nil {
		log.Printf("âŒ è¿æ¥ STUN æœåŠ¡å™¨å¤±è´¥: %v\n", err)
		return false
	}

	stunConn = conn
	localPort := conn.LocalAddr().(*net.TCPAddr).Port
	fmt.Printf("âœ… TCP è¿æ¥å·²å»ºç«‹: %s (æœ¬åœ°ç«¯å£: %d)\n", bestSTUN, localPort)

	msg := stun.MustBuild(stun.TransactionID, stun.BindingRequest)
	_, err = stunConn.Write(msg.Raw)
	if err != nil {
		log.Printf("âŒ å‘é€ STUN è¯·æ±‚å¤±è´¥: %v\n", err)
		return false
	}

	stunConn.SetReadDeadline(time.Now().Add(5 * time.Second))
	buf := make([]byte, 1024)
	n, err := stunConn.Read(buf)
	stunConn.SetReadDeadline(time.Time{})

	if err != nil || n == 0 {
		log.Printf("âŒ è¯»å– STUN å“åº”å¤±è´¥: %v\n", err)
		return false
	}

	response := &stun.Message{Raw: buf[:n]}
	if err := response.Decode(); err != nil {
		log.Printf("âŒ è§£æ STUN å“åº”å¤±è´¥: %v\n", err)
		return false
	}

	var xorAddr stun.XORMappedAddress
	if err := xorAddr.GetFrom(response); err != nil {
		log.Printf("âŒ è·å–æ˜ å°„åœ°å€å¤±è´¥: %v\n", err)
		return false
	}

	publicIP = xorAddr.IP.String()
	stunMappedPort = xorAddr.Port

	fmt.Printf("âœ… è¿è¥å•† NAT æ˜ å°„è·å–æˆåŠŸï¼\n")
	fmt.Printf("   å…¬ç½‘ IP: %s\n", publicIP)
	fmt.Printf("   ğŸ”‘ æ˜ å°„ç«¯å£: %d (è¿™æ˜¯å…³é”®ï¼)\n", stunMappedPort)
	fmt.Printf("   æœ¬åœ°ç«¯å£: %d\n", localPort)

	return true
}

// ========== æ­¥éª¤ 4: æ£€æµ‹ NAT ç±»å‹ ==========
func detectNATType() {
	conn, err := net.DialTimeout("tcp", bestSTUN, 3*time.Second)
	if err != nil {
		natType = "æ£€æµ‹å¤±è´¥"
		fmt.Println("âš ï¸  NAT ç±»å‹æ£€æµ‹å¤±è´¥")
		return
	}
	defer conn.Close()

	msg := stun.MustBuild(stun.TransactionID, stun.BindingRequest)
	conn.Write(msg.Raw)

	conn.SetReadDeadline(time.Now().Add(3 * time.Second))
	buf := make([]byte, 1024)
	n, _ := conn.Read(buf)

	if n == 0 {
		natType = "æ£€æµ‹å¤±è´¥"
		fmt.Println("âš ï¸  NAT ç±»å‹æ£€æµ‹å¤±è´¥")
		return
	}

	response := &stun.Message{Raw: buf[:n]}
	response.Decode()

	var xorAddr stun.XORMappedAddress
	xorAddr.GetFrom(response)

	ip2 := xorAddr.IP.String()
	port2 := xorAddr.Port

	if ip2 == publicIP && port2 == stunMappedPort {
		natType = "Endpoint-Independent (å®Œç¾)"
		fmt.Println("âœ… NAT ç±»å‹: Endpoint-Independent Mapping")
		fmt.Println("   ä¸åŒè¿æ¥ä½¿ç”¨ç›¸åŒçš„å…¬ç½‘ç«¯å£ï¼Œæœ€é€‚åˆç©¿é€ï¼")
	} else {
		natType = "Address-Dependent (ä¸€èˆ¬)"
		fmt.Println("âš ï¸  NAT ç±»å‹: Address-Dependent Mapping")
		fmt.Println("   ä¸åŒç›®æ ‡ä½¿ç”¨ä¸åŒç«¯å£ï¼Œéœ€è¦ä¿æŒè¿æ¥æ´»è·ƒ")
	}
}

// ========== æ­¥éª¤ 5: ç¨³å®šç‰ˆ UPnP ç«¯å£æ˜ å°„ ==========
func setupStableUPnPMapping() {
	fmt.Println("ğŸ” æ­£åœ¨å‘ç° UPnP ç½‘å…³...")

	clients, _, err := internetgateway1.NewWANIPConnection1Clients()
	if err != nil || len(clients) == 0 {
		log.Printf("âŒ UPnP å‘ç°å¤±è´¥: %v\n", err)
		log.Println("ğŸ’¡ å¯èƒ½åŸå› ï¼šè·¯ç”±å™¨æœªå¼€å¯ UPnP")
		return
	}

	upnpClients = clients
	fmt.Printf("âœ… å‘ç° %d ä¸ª UPnP ç½‘å…³\n", len(clients))

	// è·å–è·¯ç”±å™¨å¤–éƒ¨ IP
	externalIP, err := clients[0].GetExternalIPAddress()
	if err != nil {
		log.Printf("âŒ è·å–è·¯ç”±å™¨å¤–éƒ¨ IP å¤±è´¥: %v\n", err)
		return
	}
	routerIP = externalIP
	fmt.Printf("âœ… è·¯ç”±å™¨å¤–éƒ¨ IP: %s\n", routerIP)

	// æ£€æµ‹åŒå±‚ NAT
	if routerIP != publicIP {
		isDoubleNAT = true
		fmt.Println("\nğŸ¯ ========== æ£€æµ‹åˆ°åŒå±‚ NATï¼Œå¯ç”¨ç«¯å£åŒæ­¥ç­–ç•¥ ========== ğŸ¯")
		fmt.Printf("   STUN å…¬ç½‘ IP:     %s (è¿è¥å•† NAT)\n", publicIP)
		fmt.Printf("   è·¯ç”±å™¨å¤–éƒ¨ IP:    %s (å†…ç½‘ç½‘å…³)\n", routerIP)
		fmt.Printf("   è¿è¥å•†åˆ†é…ç«¯å£:   %d â¬… å…³é”®ï¼\n", stunMappedPort)
		fmt.Printf("   æœ¬æœºå†…ç½‘ IP:      %s\n", localIP)
		fmt.Println("\nğŸ’¡ ç©¿é€ç­–ç•¥ï¼ˆç¨³å®šç‰ˆï¼‰:")
		fmt.Printf("   1. è·¯ç”±å™¨ UPnP æ°¸ä¹…æ˜ å°„ï¼šå¤–éƒ¨ç«¯å£ %d â†’ æœ¬åœ° %s:%d\n", stunMappedPort, localIP, LocalServicePort)
		fmt.Println("   2. è‡ªåŠ¨å¤„ç†ç«¯å£å†²çªï¼ˆå¿½ç•¥ 718 é”™è¯¯ï¼‰")
		fmt.Println("   3. å°è¯•æ‰€æœ‰å¯ç”¨ç½‘å…³å®¢æˆ·ç«¯")
		fmt.Println("   4. ä¿æŒ TCP STUN è¿æ¥æ´»è·ƒ")
		fmt.Printf("   5. å¤–ç½‘è®¿é—®: http://%s:%d\n", publicIP, stunMappedPort)
		fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	}

	// æ·»åŠ ç«¯å£æ˜ å°„ï¼ˆç¨³å®šç‰ˆç­–ç•¥ï¼‰
	fmt.Println("\nğŸ“¡ æ­£åœ¨åˆ›å»ºç«¯å£æ˜ å°„ï¼ˆç¨³å®šç‰ˆï¼‰...")
	success := addStablePortMapping(stunMappedPort, "TCP", "TCP-STUN-Synced")

	if !success {
		fmt.Printf("\nğŸ’¡ å°è¯•è¿è¥å•†ç«¯å£é™„è¿‘çš„ç«¯å£ (%dÂ±50)...\n", stunMappedPort)
		for offset := 1; offset <= 50; offset++ {
			for _, port := range []int{stunMappedPort + offset, stunMappedPort - offset} {
				if port < 1024 || port > 65535 {
					continue
				}

				if port%10 == 0 {
					fmt.Printf("   å°è¯•ä¸­... %d\r", port)
				}

				if addStablePortMapping(port, "TCP", fmt.Sprintf("TCP-STUN-%d", port)) {
					routerMappedPort = port
					fmt.Printf("\nâœ… æ‰¾åˆ°å¯ç”¨ç«¯å£: %d â†’ æœ¬åœ° %d\n", port, LocalServicePort)

					if port == stunMappedPort {
						fmt.Println("ğŸ‰ å®Œç¾ï¼ç«¯å£å®Œå…¨åŒæ­¥ï¼")
					} else {
						fmt.Printf("âš ï¸  ç«¯å£ä¸å®Œå…¨åŒæ­¥ï¼ˆå·®è·: %dï¼‰\n", abs(port-stunMappedPort))
						fmt.Println("   å¯èƒ½éœ€è¦æ‰‹åŠ¨é…ç½®è·¯ç”±å™¨ç«¯å£è½¬å‘")
					}
					return
				}
			}
		}

		fmt.Println("\nâŒ ç«¯å£æ˜ å°„å¤±è´¥")
		fmt.Println("ğŸ’¡ å¯èƒ½åŸå› :")
		fmt.Println("   1. è·¯ç”±å™¨ UPnP æƒé™é™åˆ¶")
		fmt.Println("   2. ç«¯å£è¢«å…¶ä»–æœåŠ¡å ç”¨")
		fmt.Println("   3. è·¯ç”±å™¨å›ºä»¶ä¸æ”¯æŒå¤–éƒ¨ç«¯å£è‡ªå®šä¹‰")
	} else {
		routerMappedPort = stunMappedPort
		fmt.Printf("âœ… ç«¯å£åŒæ­¥æˆåŠŸï¼å¤–éƒ¨ç«¯å£: %d\n", routerMappedPort)
		fmt.Println("ğŸ‰ åŒå±‚ NAT ç©¿é€å®Œæˆï¼")

		if isDoubleNAT {
			fmt.Printf("\nâœ¨ å¤–ç½‘è®¿é—®åœ°å€: http://%s:%d\n", publicIP, stunMappedPort)
		}
	}
}

// ç¨³å®šç‰ˆç«¯å£æ˜ å°„å‡½æ•°
func addStablePortMapping(externalPort int, protocol, description string) bool {
	fmt.Printf("   å°è¯•æ˜ å°„: å¤–éƒ¨ç«¯å£ %d â†’ æœ¬åœ° %s:%d (%s)\n", externalPort, localIP, LocalServicePort, protocol)

	// å…ˆå°è¯•åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§æ˜ å°„
	for _, client := range upnpClients {
		client.DeletePortMapping("", uint16(externalPort), protocol)
	}

	// å°è¯•æ‰€æœ‰å®¢æˆ·ç«¯
	for i, client := range upnpClients {
		err := client.AddPortMapping(
			"",                       // NewRemoteHost
			uint16(externalPort),     // NewExternalPort
			protocol,                 // NewProtocol
			uint16(LocalServicePort), // NewInternalPort
			localIP,                  // NewInternalClient
			true,                     // NewEnabled
			description,              // NewPortMappingDescription
			uint32(0),                // NewLeaseDuration (0 = æ°¸ä¹…)
		)

		if err == nil {
			fmt.Printf("   âœ“ å®¢æˆ·ç«¯ %d æ˜ å°„æˆåŠŸï¼\n", i+1)
			return true
		}

		// å¿½ç•¥ 718 å†²çªé”™è¯¯ï¼ˆå¯èƒ½å·²ç»æ˜ å°„è¿‡ï¼‰
		if err.Error() == "SOAP fault. Code: s:Client | Explanation: UPnPError | Detail: <UPnPError xmlns=\"urn:schemas-upnp-org:control-1-0\"><errorCode>718</errorCode><errorDescription>ConflictInMappingEntry</errorDescription></UPnPError>" {
			fmt.Printf("   â„¹ï¸  å®¢æˆ·ç«¯ %d: ç«¯å£å·²æ˜ å°„ï¼ˆå¿½ç•¥å†²çªï¼‰\n", i+1)
			return true
		}

		// è®°å½•å…¶ä»–é”™è¯¯
		fmt.Printf("   âœ— å®¢æˆ·ç«¯ %d å¤±è´¥: %v\n", i+1, err)
	}

	return false
}

// ========== æ­¥éª¤ 6: ä¿æŒæ˜ å°„æ´»è·ƒ ==========
func keepMappingAlive() {
	ticker := time.NewTicker(15 * time.Second)
	defer ticker.Stop()

	maxRetries := 3
	retryCount := 0

	for range ticker.C {
		// é‡è¿æœºåˆ¶
		if stunConn == nil {
			for retryCount < maxRetries {
				conn, err := net.DialTimeout("tcp", bestSTUN, 5*time.Second)
				if err != nil {
					retryCount++
					log.Printf("âš ï¸  é‡è¿å¤±è´¥ (%d/%d): %v\n", retryCount, maxRetries, err)
					time.Sleep(2 * time.Second)
					continue
				}
				stunConn = conn
				retryCount = 0
				log.Println("ğŸ”„ TCP STUN è¿æ¥å·²é‡å»º")
				break
			}

			if retryCount >= maxRetries {
				log.Println("âŒ TCP STUN è¿æ¥å½»åº•å¤±è´¥ï¼Œå°è¯•åˆ‡æ¢ STUN æœåŠ¡å™¨...")
				selectBestSTUN()
				retryCount = 0
				continue
			}
		}

		// å‘é€å¿ƒè·³
		msg := stun.MustBuild(stun.TransactionID, stun.BindingRequest)
		_, err := stunConn.Write(msg.Raw)
		if err != nil {
			log.Printf("âš ï¸  TCP STUN å¿ƒè·³å¤±è´¥: %v\n", err)
			stunConn.Close()
			stunConn = nil
			continue
		}

		// è¯»å–å“åº”
		stunConn.SetReadDeadline(time.Now().Add(5 * time.Second))
		buf := make([]byte, 1024)
		n, err := stunConn.Read(buf)
		stunConn.SetReadDeadline(time.Time{})

		if err != nil || n == 0 {
			log.Printf("âš ï¸  TCP STUN å“åº”å¤±è´¥: %v\n", err)
			stunConn.Close()
			stunConn = nil
			continue
		}

		// æ£€æµ‹ç«¯å£å˜åŒ–å¹¶è‡ªåŠ¨é‡æ–°æ˜ å°„
		response := &stun.Message{Raw: buf[:n]}
		if response.Decode() == nil {
			var xorAddr stun.XORMappedAddress
			if xorAddr.GetFrom(response) == nil {
				currentPort := xorAddr.Port
				if currentPort != stunMappedPort {
					log.Printf("âš ï¸  è­¦å‘Šï¼šè¿è¥å•†ç«¯å£å·²å˜åŒ– %d â†’ %d\n", stunMappedPort, currentPort)
					oldPort := stunMappedPort
					stunMappedPort = currentPort

					// è‡ªåŠ¨é‡æ–°æ˜ å°„
					if len(upnpClients) > 0 && isDoubleNAT {
						log.Println("ğŸ”„ æ­£åœ¨é‡æ–°åŒæ­¥ UPnP æ˜ å°„...")

						// åˆ é™¤æ—§æ˜ å°„
						for _, client := range upnpClients {
							client.DeletePortMapping("", uint16(oldPort), "TCP")
						}

						// åˆ›å»ºæ–°æ˜ å°„
						if addStablePortMapping(currentPort, "TCP", "TCP-STUN-Synced") {
							routerMappedPort = currentPort
							log.Printf("âœ… UPnP å·²é‡æ–°åŒæ­¥åˆ°æ–°ç«¯å£: %d\n", currentPort)
							log.Printf("ğŸŒ æ–°çš„å¤–ç½‘è®¿é—®åœ°å€: http://%s:%d\n", publicIP, currentPort)
						} else {
							log.Println("ğŸ’¡ å°è¯•é™„è¿‘ç«¯å£...")
							for offset := 1; offset <= 10; offset++ {
								testPort := currentPort + offset
								if testPort > 65535 {
									break
								}

								if addStablePortMapping(testPort, "TCP", fmt.Sprintf("TCP-STUN-%d", testPort)) {
									routerMappedPort = testPort
									log.Printf("âœ… UPnP å·²æ˜ å°„åˆ°ç«¯å£: %d (å·®è·: %d)\n", testPort, abs(testPort-currentPort))
									break
								}
							}
						}
					}
				}
			}
		}

		log.Printf("ğŸ”„ åŒå±‚ NAT æ˜ å°„ä¿æ´»æˆåŠŸ (è¿è¥å•†ç«¯å£: %d, è·¯ç”±å™¨ç«¯å£: %d)\n", stunMappedPort, routerMappedPort)
	}
}

// ========== æ˜¾ç¤ºæœ€ç»ˆä¿¡æ¯ ==========
func displayFinalInfo() {
	fmt.Println("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	fmt.Println("ğŸ“Š åŒå±‚ NAT ç©¿é€ç»“æœï¼ˆç¨³å®šç‰ˆï¼‰")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

	if isDoubleNAT {
		fmt.Println("\nğŸ¯ åŒå±‚ NAT ç¯å¢ƒ")
		fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
		fmt.Printf("ğŸŒ çœŸå®å…¬ç½‘ IP:        %s\n", publicIP)
		fmt.Printf("ğŸ”‘ è¿è¥å•†åˆ†é…ç«¯å£:     %d â¬… TCP STUN æ¢æµ‹\n", stunMappedPort)
		fmt.Printf("ğŸ  è·¯ç”±å™¨å¤–éƒ¨ IP:      %s\n", routerIP)
		fmt.Printf("ğŸ”§ è·¯ç”±å™¨æ˜ å°„ç«¯å£:     %d â¬… UPnP é…ç½®\n", routerMappedPort)
		fmt.Printf("ğŸ’» æœ¬æœºå†…ç½‘ IP:        %s\n", localIP)
		fmt.Printf("ğŸ“¡ æœ¬åœ°æœåŠ¡ç«¯å£:       %d\n", LocalServicePort)

		fmt.Println("\nğŸ”„ ç«¯å£æ˜ å°„é“¾è·¯:")
		fmt.Printf("   äº’è”ç½‘ â†’ %s:%d (è¿è¥å•† NAT)\n", publicIP, stunMappedPort)
		fmt.Printf("          â†“\n")
		fmt.Printf("   %s:%d (å®¶åº­è·¯ç”±å™¨)\n", routerIP, routerMappedPort)
		fmt.Printf("          â†“\n")
		fmt.Printf("   %s:%d (æœ¬æœºæœåŠ¡)\n", localIP, LocalServicePort)

		if routerMappedPort == stunMappedPort {
			fmt.Println("\nâœ… ç©¿é€çŠ¶æ€: æˆåŠŸï¼")
			fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
			fmt.Printf("ğŸŒ å¤–ç½‘è®¿é—®åœ°å€: http://%s:%d\n", publicIP, stunMappedPort)
			fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
			fmt.Println("\nğŸ’¡ æŠ€æœ¯è¯´æ˜ï¼ˆç¨³å®šç‰ˆï¼‰:")
			fmt.Println("   â€¢ TCP STUN æ¢æµ‹åˆ°è¿è¥å•† NAT ç«¯å£")
			fmt.Println("   â€¢ UPnP æ°¸ä¹…æ˜ å°„è·¯ç”±å™¨ç«¯å£ï¼ˆLeaseDuration=0ï¼‰")
			fmt.Println("   â€¢ è‡ªåŠ¨å¤„ç†ç«¯å£å†²çªï¼ˆå¿½ç•¥ 718 é”™è¯¯ï¼‰")
			fmt.Println("   â€¢ å°è¯•æ‰€æœ‰å¯ç”¨ UPnP ç½‘å…³å®¢æˆ·ç«¯")
			fmt.Println("   â€¢ ä¿æŒå¿ƒè·³ç»´æŒä¸¤å±‚ NAT æ˜ å°„")
			fmt.Println("   â€¢ ç«¯å£å˜åŒ–æ—¶è‡ªåŠ¨é‡æ–°æ˜ å°„")
		} else {
			fmt.Println("\nâš ï¸  ç©¿é€çŠ¶æ€: éƒ¨åˆ†æˆåŠŸ")
			fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
			fmt.Printf("âš ï¸  ç«¯å£æœªå®Œå…¨åŒæ­¥ï¼ˆå·®è·: %dï¼‰\n", abs(routerMappedPort-stunMappedPort))
			fmt.Println("\nğŸ’¡ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:")
			fmt.Println("   1. æ‰‹åŠ¨åœ¨è·¯ç”±å™¨é…ç½®ç«¯å£è½¬å‘:")
			fmt.Printf("      å¤–éƒ¨ç«¯å£: %d â†’ å†…ç½‘ %s:%d\n", stunMappedPort, localIP, routerMappedPort)
			fmt.Println("   2. æ£€æŸ¥è·¯ç”±å™¨ UPnP æƒé™è®¾ç½®")
			fmt.Println("   3. å°è¯•é‡å¯è·¯ç”±å™¨åé‡æ–°è¿è¡Œ")
			fmt.Println("   4. ç¨‹åºä¼šè‡ªåŠ¨ç›‘æµ‹ç«¯å£å˜åŒ–å¹¶é‡æ–°æ˜ å°„")
		}
	} else {
		fmt.Println("\nâœ… å•å±‚ NAT ç¯å¢ƒ")
		fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
		fmt.Printf("ğŸŒ å…¬ç½‘ IP:            %s\n", publicIP)
		fmt.Printf("ğŸ”§ æ˜ å°„ç«¯å£:           %d\n", routerMappedPort)
		fmt.Printf("ğŸ’» æœ¬æœºå†…ç½‘ IP:        %s\n", localIP)
		fmt.Printf("ğŸ“¡ æœ¬åœ°æœåŠ¡ç«¯å£:       %d\n", LocalServicePort)
		fmt.Printf("\nğŸŒ å¤–ç½‘è®¿é—®åœ°å€: http://%s:%d\n", publicIP, routerMappedPort)
	}

	fmt.Println("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	fmt.Println("ğŸ”§ ç»´æŠ¤ä¿¡æ¯ï¼ˆç¨³å®šç‰ˆï¼‰")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	fmt.Println("âœ“ TCP STUN è¿æ¥ä¿æ´»: 15ç§’/æ¬¡")
	fmt.Println("âœ“ UPnP æ˜ å°„ç±»å‹: æ°¸ä¹…æ˜ å°„")
	fmt.Println("âœ“ NAT ç±»å‹:", natType)
	fmt.Println("âœ“ è‡ªåŠ¨ç«¯å£é‡æ˜ å°„: å·²å¯ç”¨")
	fmt.Println("âœ“ å†²çªå¤„ç†: å¿½ç•¥ 718 é”™è¯¯")
	fmt.Printf("âœ“ å¯ç”¨ UPnP ç½‘å…³: %d ä¸ª\n", len(upnpClients))
	fmt.Println("\nğŸ’¡ æ³¨æ„äº‹é¡¹:")
	fmt.Println("   â€¢ ä¿æŒç¨‹åºè¿è¡Œä»¥ç»´æŒ NAT æ˜ å°„")
	fmt.Println("   â€¢ è¿è¥å•†ç«¯å£å˜åŒ–æ—¶ä¼šè‡ªåŠ¨é‡æ–°æ˜ å°„")
	fmt.Println("   â€¢ æ°¸ä¹…æ˜ å°„æ›´ç¨³å®šï¼Œæ— éœ€å®šæœŸç»­æœŸ")
	fmt.Println("   â€¢ é‡å¯è·¯ç”±å™¨åéœ€è¦é‡æ–°è¿è¡Œ")
	fmt.Println("   â€¢ å¦‚æœå…¬ç½‘ IP å˜åŒ–ï¼Œéœ€è¦é‡æ–°ç©¿é€")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
}

// ========== è¾…åŠ©å‡½æ•° ==========

// è·å–æœ¬æœºå†…ç½‘ IP
func getLocalIPAddr() (string, error) {
	addrs, err := net.InterfaceAddrs()
	if err != nil {
		return "", err
	}

	for _, addr := range addrs {
		if ipnet, ok := addr.(*net.IPNet); ok && !ipnet.IP.IsLoopback() {
			if ipnet.IP.To4() != nil {
				return ipnet.IP.String(), nil
			}
		}
	}
	return "", fmt.Errorf("æœªæ‰¾åˆ°æœ¬æœºIPåœ°å€")
}

// ç»å¯¹å€¼å‡½æ•°
func abs(x int) int {
	if x < 0 {
		return -x
	}
	return x
}
